<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>newtest</title>
    <style>
        body {
            padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
        }
    </style>

    <link rel="stylesheet" href="/view/生态文明/lib/leaflet/leaflet.css" />
    <link href="/view/生态文明/lib/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="/view/生态文明/stylesheets/ui.css" rel="stylesheet">


    <script type="text/javascript" src="/view/生态文明/lib/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="/view/生态文明/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="lib/leaflet/leaflet.js"></script>

    <script type="text/javascript" src='/view/生态文明/lib/leaflet/leaflet.ChineseTmsProviders.js'></script>
    <script src="/view/生态文明/Chart.js-2.1.6/dist/Chart.bundle.js"></script>
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>
<body>

<div class="navbar navbar-inverse">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="#">房地产曲线图</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    <li class="active">中国科学院地理科学与资源研究所</li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row-fluid">
        <div id="map" class="span9"></div>
    </div>
</div>
<div id="myModal" style="margin: 3%;height: 90%; width: 90%"  class="modal fade bs-example-modal-sm" role="dialog" aria-labelledby="mySmallModalLabel">
    <div class="modal-dialog modal-sm" style="width: 85%;height: 85%;width: 85%;height: 90%;">
        <!--上一行是调节表格后面的白色模板的-->
        <div class="modal-content" style="width: 90%;height: 90%;width: 90%;height: 90%">
            <!---->
            <canvas id="myChart" style="width: 90%;height: 90%;width: 90%;height: 90%"></canvas>

        </div>
    </div>
</div>
<script type="text/javascript">
    var map;
    var resize = function () {
        var $map = $('#map');
        $map.height($(window).height() - $('div.navbar').outerHeight());
        if (map) {
            map.invalidateSize();
        }
    };
    $(window).on('resize', function () {
        resize();
    });
    resize();
    var normalm = L.tileLayer.chinaProvider('GaoDe.Normal.Map',{maxZoom:18,minZoom:5});
    var imgm = L.tileLayer.chinaProvider('GaoDe.Satellite.Map',{maxZoom:18,minZoom:5});
    var imga = L.tileLayer.chinaProvider('GaoDe.Satellite.Annotion',{maxZoom:18,minZoom:5});
    var normal = L.layerGroup([normalm]),
            image = L.layerGroup([imgm,imga]);
    var baseLayers = {
        "地图":normal,
        "影像":image,
    }
    var overlayLayers = {};
    map = L.map("map",{
        layers:[normal],
        zoomControl:true
    }).setView([39.8, 116.3], 3); /* 39°54'27"，东经116°23'17*/
    map.setView([39.8, 116.3], 3);
    map.on('zoomstart', function(e) {
       console.log("zoomstart");
    });
    map.on('zoomend', function(e) {
        console.log("zoomend");
        for (var i in rects){
            map=map.removeLayer(i);
        }
        rects=[];
        //这里先删除旧的layer
        //map.remove();
        $.post("/gridcolor",""+map.getZoom(), function(result){
            var price= JSON.parse(result);
            draw(price);
        });
    });
    var layerControl = new L.Control.Layers();
    layerControl.addTo(map);
    resize();

    //这个接口是用来传递网格的color和code的
    $(document).ready(function(){
        $.post("/gridcolor",""+map.getZoom(), function(result){
            var price= JSON.parse(result);

            draw(price);
            var mainbound = [[39.90960456049752,116.3972282409668], [39.91960456049752,115.44007]];//(左下角，右上角)
            map.fitBounds(mainbound);

        });
    });

    //生成随机颜色和尺度
    var randomScalingFactor = function() {
        return Math.round(Math.random() * 100);
        //return 0;
    };
    var randomColorFactor = function() {
        return Math.round(Math.random() * 255);
    };
    var randomColor = function(opacity) {
        return 'rgba(' + randomColorFactor() + ',' + randomColorFactor() + ',' + randomColorFactor() + ',' + (opacity || '.3') + ')';
    };

    //表格所需要的数据结构
    function dataStruct(parameter){
        var config = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: "form one",
                    data: [],
                    fill: false,
                    borderDash: [5, 5],
                }, {
                    hidden: true,
                    label: 'form two',
                    data: [],
                }]
            },
            options: {
                responsive: true,
                title:{
                    display:true,
                    text:'Chart.js Line Chart'
                },
                tooltips: {
                    mode: 'label',
                    callbacks: {
                        beforeTitle: function() {
                            return '...beforeTitle';
                        },
                        afterTitle: function() {
                            return '...afterTitle';
                        },
                        beforeBody: function() {
                            return '...beforeBody';
                        },
                        afterBody: function() {
                            return '...afterBody';
                        },
                        beforeFooter: function() {
                            return '...beforeFooter';
                        },
                        footer: function() {
                            return 'Footer';
                        },
                        afterFooter: function() {
                            return '...afterFooter';
                        },
                    }
                },
                hover: {
                    mode: 'dataset'
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            show: true,
                            labelString: 'Month'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            show: true,
                            labelString: 'Value'
                        },
                        ticks: {
                            suggestedMin: 0,
                            suggestedMax: 250,
                        }
                    }]
                }
            }
        };
        for(var i=0;i<parameter.data.length;i++){
            config.data.labels.push(parameter.data[i].date);
        }
        for(var i=0;i<parameter.data.length;i++){
            config.data.datasets[0].data.push(parameter.data[i].average_price);
        }
        for(var i=0;i<parameter.data.length;i++){
            config.data.datasets[1].data.push(parameter.data[i].average_price);
        }
        //给曲线随机赋颜色值
        for(var i=0;i<config.data.datasets.length;i++){
            config.data.datasets[i].borderColor = randomColor(0.4);
            config.data.datasets[i].backgroundColor = randomColor(0.5);
            config.data.datasets[i].pointBorderColor = randomColor(0.7);
            config.data.datasets[i].pointBackgroundColor = randomColor(0.5);
            config.data.datasets[i].pointBorderWidth = 1;

        }

        return config;
    }
    var rects=[];
    var pricedata;

    function draw(price) {
        var width=0.011785999999997188;//每一千米的经度差
        var length=0.009003999999997347;//每一千米的纬度差
        console.log(price);
        var row;
        var col;

        for( row=50;row<51;row++){
            for(col=28;col<36;col++){
                var dist_wid=(col-1)*width;//网格是从左至右一行一行地填充，故对于某一固定的行，每个网格距离初始网格的经度跨度一直在变，而纬度跨度不变
                var dist_len=(row-1)*length;
                var bounds = [[39.438283+dist_len,(115.417284+dist_wid)], [39.447286999999996+dist_len,(115.42907+dist_wid)]];//(左下角，右上角)
                var rect;
                var gridcode=(col+179*(row-1));//计算每个网格的编码值，这里的179表示总共的列数，不可改变。
                var gridvalue=price.data[gridcode];
                var code=""+gridcode;

                rect= L.rectangle(bounds, {color:mycolor(100),opacity:0.9,fillColor:gridvalue.color,weight:1,fillOpacity:0.6,className:code});
                rect.index=gridcode;
                rect.data=price.data[rect.index];
                rect.on('click', function(code){
                    //console.log(rect.code);
                    var json={
                        "collname":"rentout_code",
                        "type":"fang",
                        "code":this.data.code
                    };
                    $.post("/price", JSON.stringify(json),
                            function(data,status){
                                var ctx = document.getElementById("myChart").getContext("2d");
                                pricedata= JSON.parse(data);
                                window.myLine = new Chart(ctx, dataStruct(pricedata));
                                $('#myModal').modal()
                            }
                    )
                });
                rect.addTo(map);
                rects.push(rect);

            }
        }

    }
    function mycolor(n) {
        var r=238,g=99,b=n;
        var color="rgb("+r+","+g+","+b+")";
        return color;
    }
</script>
</body>
</html>